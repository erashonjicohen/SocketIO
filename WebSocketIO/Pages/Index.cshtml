@page "/"
@{
    ViewData["Title"] = "KiSoft One - Sistema de Gesti√≥n";
}

<div class="container-fluid mt-5">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2>üè≠ Sistema KiSoft One - Gesti√≥n de Almac√©n</h2>
                </div>
                <div class="card-body">
                    <div id="statusMessage" class="alert" role="alert" style="display:none;"></div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h4>1Ô∏è‚É£ Verificar Servidor</h4>
                            <div class="form-group">
                                <label>IP del Servidor KiSoft One:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="ipAddress" value="192.168.1.100" placeholder="192.168.1.100">
                                    <button type="button" class="btn btn-primary" onclick="checkHealth()">
                                        üîç Diagnosticar
                                    </button>
                                </div>
                                <small class="form-text text-muted">Primero verifica si el servidor responde</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4>2Ô∏è‚É£ Conectar</h4>
                            <button type="button" class="btn btn-success btn-lg btn-block mt-3" id="connectBtn" onclick="initializeConnection()" disabled>
                                üîó Conectar a KiSoft One
                            </button>
                            <small class="form-text text-muted">Se habilita despu√©s de diagnosticar</small>
                        </div>
                    </div>

                    <hr>

                    <h4>üìä Estado del Sistema</h4>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Servidor ASP.NET:</strong></td>
                            <td id="aspStatus">‚úÖ En l√≠nea</td>
                        </tr>
                        <tr>
                            <td><strong>KiSoft One:</strong></td>
                            <td id="kiSoftStatus">‚ùå Sin conectar</td>
                        </tr>
                        <tr>
                            <td><strong>√öltima verificaci√≥n:</strong></td>
                            <td id="lastCheck">-</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Paneles de Operaciones -->
    <div class="row mt-4">
        <!-- Pedidos -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4>üì¶ Gesti√≥n de Pedidos</h4>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>N√∫mero de Pedido:</label>
                        <input type="text" class="form-control" id="orderNumber" placeholder="ORD20240001">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-success btn-block mt-2" onclick="createOrder()">
                            ‚ûï Crear Pedido
                        </button>
                        <button class="btn btn-danger btn-block mt-2" onclick="deleteOrder()">
                            üóëÔ∏è Eliminar Pedido
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Art√≠culos -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h4>üìã Datos Maestros</h4>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>N√∫mero de Art√≠culo:</label>
                        <input type="text" class="form-control" id="articleNumber" placeholder="ART0001">
                    </div>
                    <div class="form-group">
                        <label>Nombre:</label>
                        <input type="text" class="form-control" id="articleName" placeholder="Nombre del art√≠culo">
                    </div>
                    <button class="btn btn-secondary btn-block" onclick="createArticle()">
                        ‚ûï Crear Art√≠culo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Log -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h4>üìã Log de Operaciones</h4>
                </div>
                <div class="card-body">
                    <div id="logContainer" style="height: 250px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; font-family: monospace; font-size: 12px;">
                        <p class="text-muted">Inicializando...</p>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary mt-2" onclick="clearLog()">üóëÔ∏è Limpiar Log</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: none;
    }

    .card-header {
        border-bottom: 3px solid rgba(0,0,0,0.125);
    }

    .btn {
        border-radius: 4px;
        font-weight: 500;
    }

    .alert {
        border-radius: 4px;
    }
</style>

<script src="~/lib/jquery/jquery.min.js"></script>
<script>
    const apiBaseUrl = '/api';
    let isConnected = false;
    let requestTimeout = 5000; // 5 segundos

    // Log helper
    function addLog(msg) {
        const container = document.getElementById('logContainer');
        const time = new Date().toLocaleTimeString();
        const entry = document.createElement('div');
        entry.innerHTML = `<span style="color: #666;">[${time}]</span> ${msg}`;
        container.insertBefore(entry, container.firstChild);
    }

    function showStatus(msg, type = 'info') {
        const div = document.getElementById('statusMessage');
        const colors = {
            'success': 'alert-success',
            'danger': 'alert-danger',
            'warning': 'alert-warning',
            'info': 'alert-info'
        };
        div.className = `alert ${colors[type]}`;
        div.textContent = msg;
        div.style.display = 'block';
        setTimeout(() => div.style.display = 'none', 4000);
    }

    function clearLog() {
        document.getElementById('logContainer').innerHTML = '<p class="text-muted">Log limpiado</p>';
    }

    // Funci√≥n helper para llamadas API CON TIMEOUT
    async function apiCall(url, options = {}) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), requestTimeout);

        try {
            const response = await fetch(url, {
                ...options,
                signal: controller.signal,
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            clearTimeout(timeoutId);

            // Leer como texto primero
            const text = await response.text();

            if (!text) {
                return { success: false, error: 'Respuesta vac√≠a' };
            }

            // Parsear JSON
            try {
                return JSON.parse(text);
            } catch (e) {
                addLog(`‚ö†Ô∏è Respuesta no-JSON: ${text.substring(0, 80)}`);
                return { success: false, error: 'Respuesta inv√°lida' };
            }
        } catch (error) {
            clearTimeout(timeoutId);
            if (error.name === 'AbortError') {
                addLog(`‚è±Ô∏è Timeout despu√©s de ${requestTimeout}ms`);
                return { success: false, error: 'Timeout' };
            }
            addLog(`‚ùå Error: ${error.message}`);
            return { success: false, error: error.message };
        }
    }

    // Verificar servidor local
    async function checkHealth() {
        addLog('üîç Verificando servidor...');
        showStatus('Verificando servidor...', 'info');

        const data = await apiCall(`${apiBaseUrl}/system/health`);

        if (data.success) {
            addLog('‚úÖ Servidor ASP.NET respondiendo');
            showStatus('‚úÖ Servidor disponible', 'success');
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('kiSoftStatus').innerHTML = '‚è≥ Listo para conectar';
            document.getElementById('lastCheck').textContent = new Date().toLocaleTimeString();
        } else {
            addLog('‚ùå Servidor no responde');
            showStatus('‚ùå Servidor no disponible', 'danger');
            document.getElementById('connectBtn').disabled = true;
        }
    }

    // Conectar a KiSoft One
    async function initializeConnection() {
        const ip = document.getElementById('ipAddress').value;
        if (!ip) {
            showStatus('Ingrese IP', 'warning');
            return;
        }

        addLog(`üîó Conectando a ${ip}:9801...`);
        showStatus(`Conectando a ${ip}...`, 'info');
        document.getElementById('connectBtn').disabled = true;

        const data = await apiCall(`${apiBaseUrl}/system/initialize?ipAddress=${ip}`, { method: 'POST' });

        if (data.success) {
            isConnected = true;
            addLog('‚úÖ Conexi√≥n exitosa con KiSoft One');
            showStatus('‚úÖ Conectado a KiSoft One', 'success');
            document.getElementById('kiSoftStatus').innerHTML = '‚úÖ Conectado';
        } else {
            addLog(`‚ùå Error: ${data.error || data.message || 'Error desconocido'}`);
            showStatus('‚ùå No se pudo conectar', 'danger');
            document.getElementById('kiSoftStatus').innerHTML = '‚ùå Error de conexi√≥n';
            document.getElementById('connectBtn').disabled = false;
        }
    }

    // Crear pedido
    async function createOrder() {
        if (!isConnected) {
            showStatus('Primero conecta al servidor', 'warning');
            return;
        }

        const num = document.getElementById('orderNumber').value;
        if (!num) {
            showStatus('Ingrese n√∫mero de pedido', 'warning');
            return;
        }

        addLog(`üì¶ Creando pedido ${num}...`);

        const data = await apiCall(`${apiBaseUrl}/order/create`, {
            method: 'POST',
            body: JSON.stringify({
                tenant: 'DEFAULT',
                orderNumber: num,
                sheetNumber: '0000',
                orderType: '01',
                loadCarrierType: 'LARGE',
                customerNumber: 'CUST001',
                theoreticalRouteNumber: 'ROUTE01',
                orderPriority: 0,
                orderLines: []
            })
        });

        if (data.success) {
            addLog(`‚úÖ Pedido ${num} creado`);
            showStatus('‚úÖ Pedido creado', 'success');
            document.getElementById('orderNumber').value = '';
        } else {
            addLog(`‚ùå Error: ${data.error || data.message}`);
            showStatus('‚ùå Error al crear pedido', 'danger');
        }
    }

    // Eliminar pedido
    async function deleteOrder() {
        const num = document.getElementById('orderNumber').value;
        if (!num) {
            showStatus('Ingrese n√∫mero de pedido', 'warning');
            return;
        }

        if (!confirm('¬øEst√°s seguro?')) return;

        addLog(`üóëÔ∏è Eliminando pedido ${num}...`);

        const data = await apiCall(`${apiBaseUrl}/order/delete?orderNumber=${num}`, { method: 'POST' });

        if (data.success) {
            addLog(`‚úÖ Pedido ${num} eliminado`);
            showStatus('‚úÖ Pedido eliminado', 'success');
        } else {
            addLog(`‚ùå Error: ${data.error || data.message}`);
            showStatus('‚ùå Error al eliminar', 'danger');
        }
    }

    // Crear art√≠culo
    async function createArticle() {
        if (!isConnected) {
            showStatus('Primero conecta al servidor', 'warning');
            return;
        }

        const num = document.getElementById('articleNumber').value;
        const name = document.getElementById('articleName').value;
        if (!num || !name) {
            showStatus('Ingrese n√∫mero y nombre', 'warning');
            return;
        }

        addLog(`üìã Creando art√≠culo ${num}...`);

        const data = await apiCall(`${apiBaseUrl}/article/create`, {
            method: 'POST',
            body: JSON.stringify({
                tenant: 'DEFAULT',
                articleNumber: num,
                articleName: name,
                station: '065',
                packingSize: '1',
                ejectionNumber: 10,
                length: 100,
                width: 100,
                height: 100,
                weight: 1000,
                minStock: 5,
                maxStock: 100,
                articleCodes: [],
                characteristics: [],
                properties: []
            })
        });

        if (data.success) {
            addLog(`‚úÖ Art√≠culo ${num} creado`);
            showStatus('‚úÖ Art√≠culo creado', 'success');
            document.getElementById('articleNumber').value = '';
            document.getElementById('articleName').value = '';
        } else {
            addLog(`‚ùå Error: ${data.error || data.message}`);
            showStatus('‚ùå Error al crear art√≠culo', 'danger');
        }
    }

    // Verificar al cargar la p√°gina
    window.addEventListener('load', function() {
        addLog('‚öôÔ∏è Inicializando interfaz...');
        checkHealth();
    });
</script>
